module.exports=[65826,a=>{"use strict";var b=a.i(37936),c=a.i(18558),d=a.i(53112),e=a.i(58840),f=a.i(22028),g=a.i(13095);let h=d.z.object({contractId:d.z.string(),title:d.z.string().min(3,"Add a descriptive milestone title."),amount:d.z.coerce.number().positive(),dueDate:d.z.string().optional().transform(a=>a?.length?a:void 0)}),i=d.z.object({milestoneId:d.z.string(),contractId:d.z.string(),deliverableUrl:d.z.string().optional().transform(a=>a?.length?a:void 0),notes:d.z.string().optional()}),j=d.z.object({milestoneId:d.z.string(),contractId:d.z.string(),status:d.z.enum(["approved","rejected"])});async function k(a,b){let d=h.safeParse({contractId:b.get("contractId"),title:b.get("title"),amount:b.get("amount"),dueDate:b.get("dueDate")});if(!d.success)return{status:"error",message:d.error.issues[0]?.message??"Invalid milestone."};let g=await (0,e.getCurrentUser)();if(!g?.profile||"employer"!==g.profile.role)return{status:"error",message:"Only employers can create milestones."};let i=(0,e.getDB)();if(!i)return{status:"error",message:"Database not available."};try{let a=await i.prepare("SELECT id, employer_id FROM contracts WHERE id = ?").bind(d.data.contractId).first();if(!a||a.employer_id!==g.profile.id)return{status:"error",message:"You do not have permission to modify this contract."};let b=(0,f.generateId)();return await i.prepare(`INSERT INTO contract_milestones (id, contract_id, title, amount, due_date, status)
         VALUES (?, ?, ?, ?, ?, 'pending')`).bind(b,d.data.contractId,d.data.title,d.data.amount,d.data.dueDate??null).run(),(0,c.revalidatePath)(`/contracts/${d.data.contractId}`),{status:"success",message:"Milestone added."}}catch(a){return{status:"error",message:a instanceof Error?a.message:"Failed to create milestone."}}}async function l(a,b){let d=i.safeParse({milestoneId:b.get("milestoneId"),contractId:b.get("contractId"),deliverableUrl:b.get("deliverableUrl"),notes:b.get("notes")});if(!d.success)return{status:"error",message:"Invalid submission."};let f=await (0,e.getCurrentUser)();if(!f?.profile||"freelancer"!==f.profile.role)return{status:"error",message:"Only freelancers can submit milestones."};let g=(0,e.getDB)();if(!g)return{status:"error",message:"Database not available."};try{let a=await g.prepare("SELECT id, contract_id FROM contract_milestones WHERE id = ?").bind(d.data.milestoneId).first();if(!a)return{status:"error",message:"Milestone not found."};let b=await g.prepare("SELECT id, freelancer_id FROM contracts WHERE id = ?").bind(a.contract_id).first();if(!b||b.freelancer_id!==f.profile.id)return{status:"error",message:"You do not have permission to update this milestone."};return await g.prepare("UPDATE contract_milestones SET status = 'in_review', deliverable_url = ?, notes = ?, updated_at = datetime('now') WHERE id = ?").bind(d.data.deliverableUrl??null,d.data.notes??null,d.data.milestoneId).run(),(0,c.revalidatePath)(`/contracts/${d.data.contractId}`),{status:"success",message:"Milestone submitted for review."}}catch(a){return{status:"error",message:a instanceof Error?a.message:"Failed to submit milestone."}}}async function m(a,b){let d=j.safeParse({milestoneId:b.get("milestoneId"),contractId:b.get("contractId"),status:b.get("status")});if(!d.success)return{status:"error",message:"Invalid status update."};let g=await (0,e.getCurrentUser)();if(!g?.profile||"employer"!==g.profile.role)return{status:"error",message:"Only employers can approve milestones."};let h=(0,e.getDB)();if(!h)return{status:"error",message:"Database not available."};try{let a=await h.prepare("SELECT id, contract_id, amount FROM contract_milestones WHERE id = ?").bind(d.data.milestoneId).first();if(!a)return{status:"error",message:"Milestone not found."};let b=await h.prepare("SELECT id, employer_id, freelancer_id FROM contracts WHERE id = ?").bind(a.contract_id).first();if(!b||b.employer_id!==g.profile.id)return{status:"error",message:"You do not have permission to update this milestone."};if(await h.prepare("UPDATE contract_milestones SET status = ?, updated_at = datetime('now') WHERE id = ?").bind(d.data.status,d.data.milestoneId).run(),"approved"===d.data.status){let c=(0,f.generateId)();await h.prepare(`INSERT INTO wallet_transactions (id, user_id, type, amount, status, reference)
           VALUES (?, ?, 'release', ?, 'pending', ?)`).bind(c,b.freelancer_id,a.amount??0,`milestone:${d.data.milestoneId}`).run()}return(0,c.revalidatePath)(`/contracts/${d.data.contractId}`),{status:"success",message:"Milestone updated."}}catch(a){return{status:"error",message:a instanceof Error?a.message:"Failed to update milestone."}}}(0,g.ensureServerEntryExports)([k,l,m]),(0,b.registerServerReference)(k,"6056b793c2905a4401aa79482b322c3b7bc28acfc2",null),(0,b.registerServerReference)(l,"602eaae21159f520e50bf97595e24303dbcde59902",null),(0,b.registerServerReference)(m,"608bb6de273b928b66ba5f7036ef8587e7ad85eebf",null),a.s([],54442),a.i(54442),a.s(["602eaae21159f520e50bf97595e24303dbcde59902",()=>l,"6056b793c2905a4401aa79482b322c3b7bc28acfc2",()=>k,"608bb6de273b928b66ba5f7036ef8587e7ad85eebf",()=>m],65826)}];

//# sourceMappingURL=_next-internal_server_app_contracts_%5Bid%5D_page_actions_8693be2e.js.map